<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Explorador Rural - Brice√±o Antioquia</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Iconos -->
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

  <!-- Turf.js y Proj4 para c√°lculo de √°rea exacta -->
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.9.1/dist/proj4.min.js"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    /* Panel de informaci√≥n */
    #info {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px 15px;
      border-radius: 12px;
      max-width: 260px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
      font-family: Arial, sans-serif;
      font-size: 14px;
    }
    /* Buscador */
    #search-container {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      padding: 6px 10px;
      border-radius: 12px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 5px;
    }
    #search-input {
      width: 160px;
      border: none;
      outline: none;
      font-size: 14px;
      background: transparent;
    }
    #home-btn {
      background: #0078a8;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }
    #home-btn:hover {
      background: #005f80;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Buscador y bot√≥n de inicio -->
  <div id="search-container">
    <i class="fas fa-search"></i>
    <input id="search-input" type="text" placeholder="Buscar predio..." />
    <button id="home-btn" title="Inicio"><i class="fas fa-home"></i></button>
  </div>

  <!-- Panel de informaci√≥n -->
  <div id="info">
    <div id="info-content">Selecciona un predio para ver detalles.</div>
  </div>

  <script>
    // Inicializar mapa
    const map = L.map('map').setView([7.111, -75.667], 12);

    // Capa base
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    let capaPredios, resaltado;

    // Cargar GeoJSON (ajusta la ruta si est√° en otra carpeta)
    fetch('Predios_Rurales.geojson')
      .then(res => res.json())
      .then(data => {
        capaPredios = L.geoJSON(data, {
          style: { color: '#0078a8', weight: 1, fillOpacity: 0.3 },
          onEachFeature: (feature, layer) => {
            layer.on('click', () => mostrarInfo(feature));
          }
        }).addTo(map);
        map.fitBounds(capaPredios.getBounds());
      })
      .catch(err => console.error('Error cargando GeoJSON:', err));

    // üìè Calcular √°rea igual a QGIS (EPSG:32618)
    function mostrarInfo(feature) {
      const info = document.getElementById('info-content');
      let areaHa = 'Sin calcular';

      try {
        proj4.defs("EPSG:4326", "+proj=longlat +datum=WGS84 +no_defs");
        proj4.defs("EPSG:32618", "+proj=utm +zone=18 +datum=WGS84 +units=m +no_defs");

        const coords4326 = feature.geometry.coordinates;
        const coords32618 = coords4326.map(ring =>
          ring.map(coord => proj4("EPSG:4326", "EPSG:32618", coord))
        );

        const featureUTM = {
          type: "Feature",
          geometry: { type: "Polygon", coordinates: coords32618 }
        };

        const areaM2 = turf.area(featureUTM);
        areaHa = (areaM2 / 10000).toFixed(2) + ' ha';
      } catch (e) {
        console.error('Error al calcular √°rea:', e);
      }

      info.innerHTML = `
        <p><b>üìÑ Matr√≠cula:</b> ${feature.properties.PK_PREDIOS || 'Sin dato'}</p>
        <p><b>üèûÔ∏è Vereda:</b> ${feature.properties.NOMBRE_VER || 'Sin dato'}</p>
        <p><b>üöú Uso:</b> ${feature.properties.Usos || 'Sin dato'}</p>
        <p><b>üìè √Årea:</b> ${areaHa}</p>
      `;

      if (resaltado) map.removeLayer(resaltado);
      resaltado = L.geoJSON(feature, { style: { color: 'yellow', weight: 3, fillOpacity: 0.1 } }).addTo(map);
      map.fitBounds(resaltado.getBounds());
    }

    // üîç Buscador de predios
    const input = document.getElementById('search-input');
    input.addEventListener('keypress', e => {
      if (e.key === 'Enter' && capaPredios) {
        const codigo = input.value.trim();
        let encontrado = null;

        capaPredios.eachLayer(layer => {
          if (layer.feature.properties.PK_PREDIOS == codigo) {
            encontrado = layer.feature;
          }
        });

        if (encontrado) {
          mostrarInfo(encontrado);
        } else {
          alert('Predio no encontrado');
        }
      }
    });

    // üè† Bot√≥n de inicio
    document.getElementById('home-btn').addEventListener('click', () => {
      if (capaPredios) map.fitBounds(capaPredios.getBounds());
      document.getElementById('info-content').innerHTML = 'Selecciona un predio para ver detalles.';
    });
  </script>
</body>
</html>
