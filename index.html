<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Briceño en Mapas</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Librerías PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f3f3f3;
    }

    #map {
      width: 100%;
      height: 400px;
      margin: 0 auto;
      border: 1px solid #ccc;
      display: block;
    }

    #info {
      width: 80%;
      margin: 10px auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      padding: 10px 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th {
      background-color: #009966;
      color: white;
      text-align: left;
      padding: 8px;
    }

    td {
      border: 1px solid #ccc;
      padding: 8px;
    }

    #extra-info {
      font-size: 10px;
      font-style: italic;
      color: #444;
      margin-top: 8px;
      border-top: 1px solid #ccc;
      padding-top: 5px;
    }

    button {
      background-color: #009966;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 15px;
      cursor: pointer;
      font-size: 13px;
      margin-top: 10px;
    }

    button:hover {
      background-color: #007a52;
    }
  </style>
</head>
<body>

  <div id="map"></div>

  <div id="info">
    <table>
      <thead>
        <tr><th>Campo</th><th>Valor</th></tr>
      </thead>
      <tbody id="info-content">
        <tr><td>PK_PREDIO</td><td>1072001000001800030</td></tr>
        <tr><td>Vereda</td><td>CUCURUCHO</td></tr>
        <tr><td>Uso</td><td>Agrosilvopastoril</td></tr>
        <tr><td>Área</td><td>2,96 ha</td></tr>
        <tr><td>% Amenaza</td><td>0%</td></tr>
        <tr><td>% Riesgo</td><td>100%</td></tr>
        <tr><td>% Protección</td><td>0%</td></tr>
      </tbody>
    </table>

    <div id="extra-info">
      Coordenadas centro: <span id="coords"></span> (EPSG:4326)<br>
      Fecha y hora: <span id="datetime"></span>
    </div>

    <button id="btnDescargarInfo">Descargar PDF</button>
  </div>

  <script>
    // === MAPA BASE ===
    const map = L.map("map").setView([7.12539, -75.59182], 15);
    L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "© OpenStreetMap"
    }).addTo(map);

    // Actualizar coordenadas y hora
    function actualizarInfoExtra() {
      const c = map.getCenter();
      document.getElementById("coords").textContent = `${c.lat.toFixed(5)}, ${c.lng.toFixed(5)}`;
      document.getElementById("datetime").textContent = new Date().toLocaleString();
    }
    actualizarInfoExtra();
    map.on("moveend", actualizarInfoExtra);

    // === DESCARGA PDF ===
    document.getElementById("btnDescargarInfo").onclick = async () => {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });

      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(16);
      pdf.text("Reporte del Predio", 105, 15, { align: "center" });

      // Capturar mapa (centrado y optimizado)
      const mapCanvas = await html2canvas(document.getElementById("map"), {
        useCORS: true,
        scale: 1.5
      });
      const imgData = mapCanvas.toDataURL("image/png");
      const imgWidth = 170;
      const imgHeight = (mapCanvas.height * imgWidth) / mapCanvas.width;
      const imgX = (210 - imgWidth) / 2;
      pdf.addImage(imgData, "PNG", imgX, 25, imgWidth, imgHeight);

      // Convertir tabla a datos
      const rows = [];
      document.querySelectorAll("#info-content tr").forEach(tr => {
        const tds = tr.querySelectorAll("td");
        rows.push([tds[0].innerText, tds[1].innerText]);
      });

      pdf.autoTable({
        startY: 130,
        head: [["Campo", "Valor"]],
        body: rows,
        theme: "grid",
        styles: { fontSize: 10, font: "helvetica" },
        headStyles: { fillColor: [0, 153, 102] }
      });

      // Recuadro gris para coordenadas y fecha
      const finalY = pdf.lastAutoTable.finalY + 5;
      pdf.setDrawColor(200);
      pdf.setFillColor(245);
      pdf.rect(10, finalY, 190, 15, "FD");
      pdf.setFont("helvetica", "italic");
      pdf.setFontSize(9);
      const c = map.getCenter();
      pdf.text(`Coordenadas centro: ${c.lat.toFixed(5)}, ${c.lng.toFixed(5)} (EPSG:4326)`, 15, finalY + 6);
      pdf.text(`Fecha y hora: ${new Date().toLocaleString()}`, 15, finalY + 12);

      pdf.save("Predio_Briceno.pdf");
    };
  </script>
</body>
</html>
