<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Brice√±o en Mapas</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Awesomplete (autocompletado) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: 'Segoe UI', sans-serif; background: #0f0f0f; color: white; }
    #map { height: 100%; width: 100%; margin-left: 310px; }

    #sidebar {
      position: absolute; top: 0; left: 0;
      width: 310px; height: 100%;
      background: #111; color: white;
      padding: 15px;
      box-shadow: 3px 0 10px rgba(0,0,0,0.4);
      overflow-y: auto; z-index: 1000;
    }

    #sidebar h2 { text-align: center; color: #00e676; margin-bottom: 10px; }
    #sidebar img { display: block; margin: 10px auto; width: 90px; border-radius: 8px; }

    .layer-option {
      display: flex; justify-content: space-between; align-items: center;
      margin: 5px 0; padding: 6px;
      background: #1b1b1b; border-radius: 6px;
    }

    .layer-option input { accent-color: #00e676; }

    #search-box {
      background: #222; border-radius: 10px; padding: 10px; margin-top: 10px; position: relative;
      display: none;
    }
    #search-input {
      width: 100%; padding: 8px; border-radius: 6px; border: none; outline: none;
    }
    #info {
      background: #1b1b1b; margin-top: 15px; padding: 10px; border-radius: 10px;
      font-size: 13px; line-height: 1.5;
    }

    .map-buttons {
      position: absolute; top: 15px; right: 15px;
      display: flex; flex-direction: column; gap: 10px; z-index: 1500;
    }

    .map-btn {
      background: #2f2f2f; border: none; border-radius: 50%;
      width: 44px; height: 44px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: background 0.3s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
      position: relative;
    }

    .map-btn:hover { background: #4a4a4a; }
    .map-btn svg { width: 22px; height: 22px; fill: white; }

    #coord-modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 3000;
    }

    #coord-box {
      background: #111; padding: 20px; border-radius: 10px; text-align: center; color: white;
    }
    #coord-box input {
      width: 90%; padding: 8px; margin: 6px 0; border-radius: 6px; border: none; text-align: center;
      background: #333; color: #fff;
    }
    #coord-box button {
      background: #00e676; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer;
    }
  </style>
</head>
<body>

  <div id="sidebar">
    <img src="escudo_briceno.jpg" alt="Escudo Brice√±o">
    <h2>Brice√±o en Mapas</h2>

    <button id="btnMostrarCapas" style="width:100%;background:#00e676;color:black;border:none;border-radius:6px;padding:8px;cursor:pointer;">
      Mostrar capas
    </button>

    <div id="capas" style="display:none;margin-top:10px;">
      <div class="layer-option">
        <span>üü© Predios Rurales</span><input type="checkbox" id="predios">
      </div>
      <div class="layer-option">
        <span>üó∫Ô∏è Veredas</span><input type="checkbox" id="veredas">
      </div>
      <div class="layer-option">
        <span>üíß Drenaje Doble</span><input type="checkbox" id="drenaje">
      </div>
    </div>

    <div id="search-box">
      <input id="search-input" placeholder="Buscar matr√≠cula (PK_PREDIOS)" />
    </div>

    <div id="info">
      <b>‚ÑπÔ∏è Informaci√≥n</b><br>Activa una capa y haz clic en el mapa.
    </div>
  </div>

  <div id="map"></div>

  <!-- Botones flotantes -->
  <div class="map-buttons">
    <button class="map-btn" id="btnHome" title="Volver al inicio">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3l9 9h-3v9h-12v-9h-3z"/></svg>
    </button>
    <button class="map-btn" id="btnLocate" title="Activar mi ubicaci√≥n">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2v2a8 8 0 1 1-8 8h-2a10 10 0 1 0 10-10z"/><circle cx="12" cy="12" r="2.5"/></svg>
    </button>
    <button class="map-btn" id="btnCoords" title="Ir a coordenadas">
      üìç
    </button>
  </div>

  <!-- Modal para coordenadas -->
  <div id="coord-modal">
    <div id="coord-box">
      <h3>üìç Ir a coordenadas</h3>
      <input id="lat" placeholder="Latitud (ej: 7.123)" />
      <input id="lng" placeholder="Longitud (ej: -75.567)" />
      <br><button id="goCoords">Ir</button>
      <br><br><button id="closeCoords" style="background:#e74c3c;">Cerrar</button>
    </div>
  </div>

  <script>
    const map = L.map('map').setView([7.113, -75.574], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // Botones
    document.getElementById("btnHome").onclick = () => map.setView([7.113, -75.574], 13);
    document.getElementById("btnLocate").onclick = () => map.locate({ setView: true, maxZoom: 16 });
    map.on('locationfound', e => L.marker(e.latlng).addTo(map).bindPopup("üìç Est√°s aqu√≠").openPopup());

    // Mostrar/Ocultar capas
    document.getElementById("btnMostrarCapas").onclick = () => {
      const c = document.getElementById("capas");
      c.style.display = c.style.display === "none" ? "block" : "none";
    };

    // Cargar capas
    const capaPredios = L.geoJSON(null, {
      onEachFeature: (f, l) => l.on('click', () => {
        const p = f.properties;
        document.getElementById("info").innerHTML = `
          <b>üìÑ Matr√≠cula:</b> ${p.PK_PREDIOS || 'Sin dato'}<br>
          <b>Vereda:</b> ${p.NOMBRE_VER || 'Sin dato'}<br>
          <b>Uso:</b> ${p.Usos || 'Sin dato'}
        `;
      }),
      style: { color: "#00e676", weight: 1, fillOpacity: 0.3 }
    });

    const capaVeredas = L.geoJSON(null, {
      onEachFeature: (f, l) => l.on('click', () => {
        const p = f.properties;
        document.getElementById("info").innerHTML = `
          <b>Vereda:</b> ${p.NOMBRE_VER || 'Sin nombre'}
        `;
      }),
      style: { color: "#4cbb17", weight: 1, fillOpacity: 0.1 }
    });

    const capaDrenaje = L.geoJSON(null, {
      onEachFeature: (f, l) => l.on('click', () => {
        const p = f.properties;
        document.getElementById("info").innerHTML = `
          <b>Fuente:</b> ${p.NMG || 'Sin nombre'}
        `;
      }),
      style: { color: "#03A9F4", weight: 1.2 }
    });

    // Archivos GeoJSON (usa tus rutas)
    fetch("Predios_Rurales.geojson").then(r => r.json()).then(d => capaPredios.addData(d));
    fetch("Veredas.geojson").then(r => r.json()).then(d => capaVeredas.addData(d));
    fetch("Drenaje_Doble.geojson").then(r => r.json()).then(d => capaDrenaje.addData(d));

    // Activar capas
    document.getElementById("predios").onchange = e => {
      if (e.target.checked) { capaPredios.addTo(map); document.getElementById("search-box").style.display = "block"; }
      else { map.removeLayer(capaPredios); document.getElementById("search-box").style.display = "none"; }
    };

    document.getElementById("veredas").onchange = e => {
      if (e.target.checked) capaVeredas.addTo(map); else map.removeLayer(capaVeredas);
    };

    document.getElementById("drenaje").onchange = e => {
      if (e.target.checked) capaDrenaje.addTo(map); else map.removeLayer(capaDrenaje);
    };

    // Autocompletado PK_PREDIOS
    let listaPredios = [];
    fetch("Predios_Rurales.geojson")
      .then(r => r.json())
      .then(data => {
        listaPredios = data.features.map(f => f.properties.PK_PREDIOS);
        new Awesomplete(document.getElementById("search-input"), { list: listaPredios });
      });

    document.getElementById("search-input").addEventListener("awesomplete-selectcomplete", e => {
      const pk = e.text.value;
      fetch("Predios_Rurales.geojson")
        .then(r => r.json())
        .then(data => {
          const f = data.features.find(x => x.properties.PK_PREDIOS == pk);
          if (f) {
            const c = turf.center(f).geometry.coordinates;
            map.setView([c[1], c[0]], 17);
            L.popup().setLatLng([c[1], c[0]]).setContent(`<b>Predio:</b> ${pk}`).openOn(map);
          }
        });
    });

    // Coordenadas
    const modal = document.getElementById("coord-modal");
    document.getElementById("btnCoords").onclick = () => modal.style.display = "flex";
    document.getElementById("closeCoords").onclick = () => modal.style.display = "none";
    document.getElementById("goCoords").onclick = () => {
      const lat = parseFloat(document.getElementById("lat").value);
      const lng = parseFloat(document.getElementById("lng").value);
      if (isNaN(lat) || isNaN(lng)) return alert("Coordenadas inv√°lidas");
      modal.style.display = "none";
      map.setView([lat, lng], 17);
      L.marker([lat, lng]).addTo(map).bindPopup(`üìç ${lat}, ${lng}`).openPopup();
    };
  </script>
</body>
</html>
