<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Explorador Rural - Brice√±o Antioquia</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Font Awesome -->
  <script
    src="https://kit.fontawesome.com/a076d05399.js"
    crossorigin="anonymous"
  ></script>

  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #map {
      width: 100%;
      height: 100%;
    }

    /* Panel superior */
    #panelBusqueda {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      text-align: center;
    }

    #titulo {
      font-family: 'Segoe UI', sans-serif;
      font-size: 18px;
      font-weight: bold;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      padding: 6px 12px;
      margin-bottom: 6px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      color: #2e7d32;
    }

    /* Buscador */
    #buscador {
      display: flex;
      align-items: center;
      background: #ffca00;
      padding: 5px 10px;
      border-radius: 40px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
      width: 280px;
      margin: 0 auto;
      position: relative;
    }

    #buscador i {
      color: #2e7d32;
      margin-right: 10px;
      font-size: 20px;
      user-select: none;
    }

    #buscador input {
      width: 100%;
      border: none;
      outline: none;
      font-size: 14px;
      background: transparent;
      border-radius: 40px;
      padding: 6px 0;
      user-select: text;
    }

    #sugerencias {
      background: white;
      border: 1px solid #ccc;
      max-height: 120px;
      overflow-y: auto;
      margin-top: 2px;
      border-radius: 5px;
      display: none;
      width: 280px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 48px;
      z-index: 1500;
    }

    #sugerencias div {
      padding: 5px;
      cursor: pointer;
    }

    #sugerencias div:hover {
      background: #f0f0f0;
    }

    /* Bot√≥n de inicio y ubicaci√≥n */
    #btnHome,
    #btnLocate {
      position: absolute;
      right: 10px;
      background: #0078a8;
      color: white !important; /* iconos blancos */
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      cursor: pointer;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: 0.2s;
      z-index: 1000;
    }

    #btnHome {
      top: 10px;
    }

    #btnLocate {
      top: 70px;
      font-size: 22px;
    }

    #btnHome:hover,
    #btnLocate:hover {
      background: #005f82;
      transform: scale(1.1);
    }
  </style>
</head>
<body>
  <!-- Panel superior -->
  <div id="panelBusqueda">
    <div id="titulo">üåΩ Explorador Rural ‚Äì Brice√±o, Antioquia</div>
    <div id="buscador">
      <i class="fas fa-search"></i>
      <input
        type="text"
        id="inputBusqueda"
        placeholder="Insertar matr√≠cula..."
        autocomplete="off"
      />
    </div>
    <div id="sugerencias"></div>
  </div>

  <!-- Bot√≥n de inicio -->
  <button id="btnHome" title="Volver al inicio">
    <i class="fas fa-home"></i>
  </button>

  <!-- Bot√≥n de geolocalizaci√≥n -->
  <button id="btnLocate" title="Mostrar mi ubicaci√≥n">
    <i class="fas fa-map-marker-alt"></i>
  </button>

  <!-- Mapa -->
  <div id="map"></div>

  <script>
    var map = L.map('map').setView([7.132, -75.569], 13);

    // Capa base OSM
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
    }).addTo(map);

    var capaPredios;
    var resaltado;
    var boundsInicial;

    // Cargar GeoJSON
    fetch('Predios_Usos_Unidos_4326.geojson')
      .then((res) => res.json())
      .then((data) => {
        capaPredios = L.geoJSON(data, {
          style: {
            color: '#2262CC',
            weight: 1,
            fillColor: '#66CCFF',
            fillOpacity: 0.4,
          },
        }).addTo(map);

        boundsInicial = capaPredios.getBounds();
        if (boundsInicial.isValid()) map.fitBounds(boundsInicial);

        inicializarBuscador(data.features);
      });

    // Buscador con autocompletado
    function inicializarBuscador(features) {
      const input = document.getElementById('inputBusqueda');
      const sugerencias = document.getElementById('sugerencias');

      input.addEventListener('input', function () {
        const texto = this.value.toLowerCase();
        sugerencias.innerHTML = '';
        if (texto.length < 1) {
          sugerencias.style.display = 'none';
          return;
        }

        const coincidencias = features
          .filter(
            (f) =>
              f.properties.PK_PREDIOS &&
              f.properties.PK_PREDIOS.toLowerCase().includes(texto)
          )
          .slice(0, 10);

        coincidencias.forEach((f) => {
          const div = document.createElement('div');
          div.textContent = f.properties.PK_PREDIOS;
          div.onclick = () => seleccionarPredio(f);
          sugerencias.appendChild(div);
        });

        sugerencias.style.display = coincidencias.length ? 'block' : 'none';
      });
    }

    // Seleccionar predio
    function seleccionarPredio(feature) {
      const sugerencias = document.getElementById('sugerencias');
      sugerencias.style.display = 'none';
      document.getElementById('inputBusqueda').value = feature.properties.PK_PREDIOS;

      if (resaltado) map.removeLayer(resaltado);

      resaltado = L.geoJSON(feature, {
        style: { color: 'red', weight: 3, fillColor: 'yellow', fillOpacity: 0.5 },
      }).addTo(map);

      const popupInfo = `
      <b>Predio:</b> ${feature.properties.PK_PREDIOS}<br>
      <b>Vereda:</b> ${feature.properties.NOMBRE_VER || 'Sin dato'}<br>
      <b>Uso:</b> ${feature.properties.Usos || 'Sin dato'}
    `;
      resaltado.bindPopup(popupInfo).openPopup();

      map.fitBounds(resaltado.getBounds().pad(1));
    }

    // Bot√≥n de inicio
    document.getElementById('btnHome').onclick = function () {
      if (resaltado) map.removeLayer(resaltado);
      document.getElementById('inputBusqueda').value = '';
      if (boundsInicial && boundsInicial.isValid()) {
        map.fitBounds(boundsInicial);
      } else {
        map.setView([7.132, -75.569], 13);
      }
    };

    // Bot√≥n de geolocalizaci√≥n
    document.getElementById('btnLocate').onclick = function () {
      map.locate({ setView: true, maxZoom: 17 });
    };

    // Manejar evento de ubicaci√≥n encontrada
    map.on('locationfound', function (e) {
      if (resaltado) map.removeLayer(resaltado);
      resaltado = L.marker(e.latlng)
        .addTo(map)
        .bindPopup('üìç Aqu√≠ est√°s')
        .openPopup();
    });

    map.on('locationerror', function (e) {
      alert('No se pudo obtener la ubicaci√≥n.');
    });
  </script>
</body>
</html>
