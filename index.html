<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Brice√±o en Mapas</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Turf.js -->
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: 'Segoe UI', sans-serif; background: #0f0f0f; color: white; }
    #map { height: 100%; width: 100%; margin-left: 310px; }

    #sidebar {
      position: absolute; top: 0; left: 0;
      width: 310px; height: 100%;
      background: #111; color: white;
      padding: 15px;
      box-shadow: 3px 0 10px rgba(0,0,0,0.4);
      overflow-y: auto; z-index: 1000;
    }

    #sidebar h2 { text-align: center; color: #00e676; margin-bottom: 10px; }
    #sidebar img { display: block; margin: 10px auto; width: 90px; border-radius: 8px; }

    details { background: #222; border-radius: 10px; padding: 10px; margin-top: 10px; }
    .layer-option {
      display: flex; justify-content: space-between; align-items: center;
      margin: 5px 0; padding: 6px;
      background: #1b1b1b; border-radius: 6px;
    }
    .layer-option input { accent-color: #00e676; }

    #search-container {
      background: #222; border-radius: 10px; padding: 10px; margin-top: 10px; position: relative;
    }
    #search-input { width: 100%; padding: 8px; border-radius: 6px; border: none; outline: none; }

    #autocomplete-list {
      position: absolute; background: #333; border-radius: 6px; z-index: 9999;
      top: 40px; left: 0; right: 0; max-height: 180px; overflow-y: auto;
    }
    .autocomplete-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #444; }
    .autocomplete-item:hover { background: #555; }

    #info-panel {
      background: #1b1b1b; margin-top: 15px; padding: 10px; border-radius: 10px;
      font-size: 13px; line-height: 1.5;
    }

    .map-buttons {
      position: absolute; top: 15px; right: 15px;
      display: flex; flex-direction: column; gap: 10px; z-index: 1500;
    }

    .map-btn {
      background: #2f2f2f; border: none; border-radius: 50%;
      width: 44px; height: 44px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: background 0.3s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
      position: relative;
    }
    .map-btn:hover { background: #4a4a4a; }
    .map-btn svg { width: 22px; height: 22px; fill: white; }
    .map-btn::after {
      content: attr(title); position: absolute; right: 52px; top: 8px;
      background: rgba(0,0,0,0.8); color: #fff; padding: 4px 8px;
      border-radius: 6px; font-size: 12px; white-space: nowrap;
      opacity: 0; transition: opacity 0.3s;
    }
    .map-btn:hover::after { opacity: 1; }

    /* Modal para coordenadas */
    #modalCoordenadas {
      display: none; position: fixed; z-index: 2000;
      left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.8);
      justify-content: center; align-items: center;
    }
    #modalContenido {
      background-color: #111; color: white; padding: 20px;
      border-radius: 10px; width: 300px; text-align: center;
      box-shadow: 0 0 10px #00e676;
    }
    #modalContenido input {
      width: 90%; margin: 8px 0; padding: 8px;
      border-radius: 6px; border: none; text-align: center;
    }
    #modalContenido button {
      margin-top: 10px; padding: 8px 16px; border: none;
      border-radius: 6px; cursor: pointer; background: #00e676; color: black;
    }
  </style>
</head>
<body>

  <div id="sidebar">
    <img src="escudo_briceno.jpg" alt="Escudo Brice√±o">
    <h2>Brice√±o en Mapas</h2>

    <!-- Bot√≥n para mostrar capas -->
    <button id="btnMostrarCapas" style="width:100%;padding:8px;background:#00e676;border:none;border-radius:8px;cursor:pointer;margin-bottom:8px;">
      üó∫Ô∏è Mostrar Capas
    </button>

    <!-- Nuevo bot√≥n para consultas -->
    <button id="btnConsulta" style="width:100%;padding:8px;background:#00e676;border:none;border-radius:8px;cursor:pointer;margin-bottom:8px;">
      üß≠ Consulta
    </button>

    <!-- Panel de capas -->
    <details id="capasTematicas" hidden>
      <div class="layer-option"><span>üü© Predios Rurales</span><input type="checkbox" id="chkPredios" checked></div>
      <div class="layer-option"><span>üåã Amenaza</span><input type="checkbox" id="chkAmenaza"></div>
      <div class="layer-option"><span>‚ö†Ô∏è Riesgo</span><input type="checkbox" id="chkRiesgo"></div>
      <div class="layer-option"><span>üõ°Ô∏è Protecci√≥n</span><input type="checkbox" id="chkProteccion"></div>
      <hr style="border: 0.5px solid #333;">
      <div class="layer-option"><span>üè† Construcciones</span><input type="checkbox" id="chkConstrucciones"></div>
      <div class="layer-option"><span>üíß Drenaje Doble</span><input type="checkbox" id="chkDrenaje"></div>
      <div class="layer-option"><span>üó∫Ô∏è Veredas</span><input type="checkbox" id="chkVeredas"></div>
    </details>

    <!-- Panel de consulta -->
    <details id="consultaPanel" hidden>
      <summary>Elige tu consulta</summary>
      <select id="consultaSelect" style="width:100%;padding:6px;border-radius:6px;border:none;margin-top:8px;">
        <option value="">-- Selecciona una capa --</option>
        <option value="Predios">Predios Rurales</option>
        <option value="Veredas">Veredas</option>
        <option value="Drenaje">Drenaje Doble</option>
      </select>
    </details>

    <!-- Buscador (solo visible si se elige Predios) -->
    <div id="search-container" style="display:none;">
      <input type="text" id="search-input" placeholder="Buscar matr√≠cula (PK_PREDIOS)">
      <div id="autocomplete-list"></div>
      <button id="btnBuscar" style="margin-top:5px;width:100%;padding:8px;background:#00e676;border:none;border-radius:6px;cursor:pointer;">
        üîç Buscar
      </button>
    </div>

    <div id="info-panel">
      <b>‚ÑπÔ∏è Informaci√≥n</b>
      <div id="info-content">Selecciona un elemento o realiza una consulta.</div>
    </div>
  </div>

  <div id="map"></div>

  <!-- Botones flotantes -->
  <div class="map-buttons">
    <button class="map-btn" id="btnHome" title="Volver al inicio">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3l9 9h-3v9h-12v-9h-3z"/></svg>
    </button>

    <button class="map-btn" id="btnCoordenadas" title="Ir a coordenadas">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C8.14 2 5 5.14 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.86-3.14-7-7-7zM12 11.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z"/></svg>
    </button>

    <button class="map-btn" id="btnUbicacion" title="Mi ubicaci√≥n">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 1 1 0 8 4 4 0 0 1 0-8m0-6a2 2 0 0 1 2 2v2a8 8 0 0 1 6 6h2a2 2 0 0 1 0 4h-2a8 8 0 0 1-6 6v2a2 2 0 0 1-4 0v-2a8 8 0 0 1-6-6h-2a2 2 0 0 1 0-4h2a8 8 0 0 1 6-6V4a2 2 0 0 1 2-2z"/></svg>
    </button>
  </div>

  <!-- Modal coordenadas -->
  <div id="modalCoordenadas">
    <div id="modalContenido">
      <h3>Ir a coordenadas</h3>
      <input type="number" id="latitudInput" placeholder="Latitud">
      <input type="number" id="longitudInput" placeholder="Longitud">
      <button id="btnIr">Ir</button>
      <button id="btnCerrar">Cerrar</button>
    </div>
  </div>

  <script>
    const baseUrl = "https://esteban-cms.github.io/BuscadorPredios/";
    const map = L.map('map').setView([7.132, -75.569], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20 }).addTo(map);

    let capas = {}, resaltado;

    function mostrarInfo(feature, titulo = "Elemento") {
      const info = document.getElementById('info-content');
      info.innerHTML = `<p><b>${titulo}</b></p>`;
      for (const [key, val] of Object.entries(feature.properties)) {
        info.innerHTML += `<p><b>${key}:</b> ${val || 'Sin dato'}</p>`;
      }
      if (resaltado) map.removeLayer(resaltado);
      resaltado = L.geoJSON(feature, { style: { color: 'yellow', weight: 3, fillOpacity: 0.1 } }).addTo(map);
      map.fitBounds(resaltado.getBounds());
    }

    function cargarCapa(nombre, archivo, estilo, visible=false) {
      fetch(baseUrl + archivo)
        .then(r => r.json())
        .then(data => {
          capas[nombre] = L.geoJSON(data, {
            style: estilo,
            onEachFeature: (f, l) => {
              l.on('click', () => mostrarInfo(f, nombre));
            }
          });
          if (visible) capas[nombre].addTo(map);
        });
    }

    cargarCapa("Predios", "Predios_Usos_Unidos_4326.geojson", { color: "#00e676", weight: 1, fillOpacity: 0.3 }, true);
    cargarCapa("Veredas", "Veredas.geojson", { color: "#9C27B0", weight: 1, fillOpacity: 0.2 });
    cargarCapa("Drenaje", "Drenaje_Doble.geojson", { color: "#03A9F4", weight: 1, fillOpacity: 0.3 });

    document.getElementById('btnHome').onclick = () => map.setView([7.132, -75.569], 13);

    document.getElementById('btnMostrarCapas').onclick = () => {
      const p = document.getElementById('capasTematicas');
      p.hidden = !p.hidden;
    };

    document.getElementById('btnConsulta').onclick = () => {
      const p = document.getElementById('consultaPanel');
      p.hidden = !p.hidden;
    };

    // Mostrar buscador solo si elige Predios
    document.getElementById('consultaSelect').onchange = (e) => {
      document.getElementById('search-container').style.display =
        e.target.value === "Predios" ? "block" : "none";
    };

    // üìç Coordenadas modal
    const modal = document.getElementById('modalCoordenadas');
    document.getElementById('btnCoordenadas').onclick = () => modal.style.display = "flex";
    document.getElementById('btnCerrar').onclick = () => modal.style.display = "none";
    document.getElementById('btnIr').onclick = () => {
      const lat = parseFloat(document.getElementById('latitudInput').value);
      const lon = parseFloat(document.getElementById('longitudInput').value);
      if (!isNaN(lat) && !isNaN(lon)) {
        L.marker([lat, lon]).addTo(map).bindPopup(`üìç ${lat}, ${lon}`).openPopup();
        map.setView([lat, lon], 15);
      }
      modal.style.display = "none";
    };

    // üì° Ubicaci√≥n
    document.getElementById('btnUbicacion').onclick = () => {
      map.locate({ setView: true, maxZoom: 16 });
      map.once('locationfound', (e) => {
        L.marker(e.latlng).addTo(map).bindPopup("üìç Est√°s aqu√≠").openPopup();
      });
    };
  </script>
</body>
</html>
