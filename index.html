<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
// ================= MAPA BASE Y CAPAS =================
const baseUrl = "https://esteban-cms.github.io/BuscadorPredios/";
const map = L.map('map').setView([7.132, -75.569], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20, attribution:'¬© OpenStreetMap'}).addTo(map);

let capas={}, resaltado, listaPredios=[], capaAmenaza, capaRiesgo, capaProteccion;

function mostrarPredio(f){
  const p = f.properties;
  const geom = f.geometry;

  function calcularPorcentaje(capa){
    if(!capa) return 0;
    let areaTotal = turf.area(f);
    let areaInter = 0;
    capa.eachLayer(l=>{
      try {
        const inter = turf.intersect(turf.feature(geom), l.feature);
        if(inter) areaInter += turf.area(inter);
      } catch(e){}
    });
    return Math.round((areaInter / areaTotal) * 100);
  }

  const pctAmenaza = calcularPorcentaje(capaAmenaza);
  const pctRiesgo  = calcularPorcentaje(capaRiesgo);
  const pctProtec  = calcularPorcentaje(capaProteccion);

  document.getElementById('info-content').innerHTML=`
    <p><b>Predio:</b> ${p.PK_PREDIOS}</p>
    <p><b>Vereda:</b> ${p.NOMBRE_VER||'Sin nombre'}</p>
    <p><b>Uso:</b> ${p.Usos||'Sin dato'}</p>
    <p><b>√Årea:</b> ${p["Area ha"]?.toLocaleString() || 'Sin dato'} ha</p>
    <p><b>% Amenaza:</b> ${pctAmenaza}%</p>
    <p><b>% Riesgo:</b> ${pctRiesgo}%</p>
    <p><b>% Protecci√≥n:</b> ${pctProtec}%</p>
  `;

  if(resaltado) map.removeLayer(resaltado);
  resaltado=L.geoJSON(f,{style:{color:'yellow',weight:3,fillOpacity:0.1}}).addTo(map);
  map.fitBounds(resaltado.getBounds(), { padding: [30, 30] });
}

// ================= CARGAR CAPAS =================
function cargarCapa(nombre, archivo, estilo, visible=false){
  fetch(baseUrl+archivo).then(r=>r.json()).then(data=>{
    capas[nombre]=L.geoJSON(data,{
      style:estilo,
      onEachFeature:(f,l)=>{
        if(nombre==="Predios") l.on('click',()=>mostrarPredio(f));
        if(nombre==="Veredas" && f.properties.NOMBRE_VER){
          l.bindTooltip(f.properties.NOMBRE_VER,{permanent:true,direction:'center',className:'vereda-label'});
        }
      }
    });
    if(visible) capas[nombre].addTo(map);
    if(nombre==="Predios") listaPredios=data.features.map(f=>f.properties.PK_PREDIOS);
  });
}

cargarCapa("Predios","Predios_Usos_Agrupados.geojson",{color:"#00e676",weight:1,fillOpacity:0.3},true);
cargarCapa("Amenaza","Condicion_Amenaza_Rura.geojson",{color:"#FF9800",weight:1,fillOpacity:0.2});
cargarCapa("Riesgo","CondicionRiesgoRural.geojson",{color:"#f44336",weight:1,fillOpacity:0.2});
cargarCapa("Proteccion","Proteccion_GestionRiesgo.geojson",{color:"#2196F3",weight:1,fillOpacity:0.2});
cargarCapa("Construcciones","ConstruccionesRurales.geojson",{color:"#8BC34A",weight:1,fillOpacity:0.3});
cargarCapa("Drenaje","Drenaje_Doble.geojson",{color:"#03A9F4",weight:1,fillOpacity:0.3});
cargarCapa("Veredas","Veredas.geojson",{color:"#9C27B0",weight:1,fillOpacity:0.2},false);

Promise.all([
  fetch(baseUrl+"Condicion_Amenaza_Rura.geojson").then(r=>r.json()),
  fetch(baseUrl+"CondicionRiesgoRural.geojson").then(r=>r.json()),
  fetch(baseUrl+"Proteccion_GestionRiesgo.geojson").then(r=>r.json())
]).then(([a,r,p])=>{capaAmenaza=L.geoJSON(a); capaRiesgo=L.geoJSON(r); capaProteccion=L.geoJSON(p);});

// ================= TOGGLE CAPAS =================
function toggleLayer(chkId,layerName){document.getElementById(chkId).addEventListener("change",()=>{if(capas[layerName]){document.getElementById(chkId).checked?map.addLayer(capas[layerName]):map.removeLayer(capas[layerName]);}});}
toggleLayer("chkPredios","Predios"); toggleLayer("chkAmenaza","Amenaza"); toggleLayer("chkRiesgo","Riesgo"); toggleLayer("chkProteccion","Proteccion");
toggleLayer("chkConstrucciones","Construcciones"); toggleLayer("chkDrenaje","Drenaje"); toggleLayer("chkVeredas","Veredas");

// ================= B√öSQUEDA =================
const input=document.getElementById("search-input"); const list=document.getElementById("autocomplete-list");
input.addEventListener("input",()=>{const val=input.value.toLowerCase(); list.innerHTML=""; if(!val) return; listaPredios.filter(p=>p && p.toLowerCase().includes(val)).slice(0,10).forEach(p=>{const item=document.createElement("div"); item.className="autocomplete-item"; item.textContent=p; item.onclick=()=>{input.value=p; list.innerHTML=""; mostrarPredio(capas["Predios"].getLayers().find(l=>l.feature.properties.PK_PREDIOS===p).feature);}; list.appendChild(item);});});
document.getElementById("btnBuscar").onclick=()=>{const p=input.value; const layer=capas["Predios"].getLayers().find(l=>l.feature.properties.PK_PREDIOS===p); layer?mostrarPredio(layer.feature):alert("No encontrado");};

// ================= BOTONES =================
document.getElementById("btnHome").onclick=()=>map.setView([7.132,-75.569],13);
document.getElementById('btnMostrarCapas').onclick=()=>{const panel=document.getElementById('capasTematicas'); panel.hidden=!panel.hidden;};

const coordModal=document.getElementById("coordModal");
document.getElementById("btnCoordenadas").onclick=()=>coordModal.style.display="flex";
document.getElementById("btnIrCoord").onclick=()=>{const lat=parseFloat(document.getElementById("latitud").value); const lon=parseFloat(document.getElementById("longitud").value); if(isNaN(lat)||isNaN(lon)) return alert("Coordenadas inv√°lidas"); coordModal.style.display="none"; map.setView([lat,lon],17); L.marker([lat,lon]).addTo(map);};
coordModal.onclick=e=>{if(e.target===coordModal) coordModal.style.display="none";};

// ================= BOT√ìN GPS =================
document.getElementById("btnUbicacion").onclick = () => {
  if (!navigator.geolocation) return alert("La geolocalizaci√≥n no es compatible con tu navegador.");
  navigator.geolocation.getCurrentPosition(
    pos => {
      const { latitude, longitude } = pos.coords;
      L.marker([latitude, longitude]).addTo(map)
        .bindPopup("üìç Mi ubicaci√≥n actual").openPopup();
      map.setView([latitude, longitude], 16);
    },
    err => alert("No se pudo obtener la ubicaci√≥n: " + err.message),
    { enableHighAccuracy: true, timeout: 8000 }
  );
};

// ================= DESCARGA PDF MEJORADA =================
document.getElementById("btnDescargarInfo").onclick = async () => {
  if (!resaltado) return alert("Selecciona un predio primero.");

  const loadingMsg = document.createElement("div");
  loadingMsg.innerText = "‚è≥ Generando reporte, por favor espera...";
  Object.assign(loadingMsg.style, {
    position: "fixed", top: "50%", left: "50%", transform: "translate(-50%, -50%)",
    background: "rgba(0,0,0,0.85)", color: "#00e676", padding: "15px 25px",
    borderRadius: "10px", fontSize: "16px", zIndex: "3000"
  });
  document.body.appendChild(loadingMsg);

  try {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });

    pdf.setFont("helvetica", "bold");
    pdf.setFontSize(16);
    pdf.text("Reporte del Predio", 105, 15, { align: "center" });

    // Imagen general con delineado del predio
    const bounds = resaltado.getBounds();
    map.fitBounds(bounds, { padding: [50, 50] });
    const overlay = L.geoJSON(resaltado.toGeoJSON(), { style: { color: "black", weight: 3, fillOpacity: 0 } }).addTo(map);
    const mapCanvas = await html2canvas(document.getElementById("map"), { useCORS: true, scale: 1.3, backgroundColor: "#ffffff" });
    pdf.addImage(mapCanvas.toDataURL("image/png"), "PNG", 10, 25, 190, 100);
    map.removeLayer(overlay);

    // Mini mapa centrado con contorno
    const miniDiv = document.createElement("div");
    Object.assign(miniDiv.style, { width: "180px", height: "120px", position: "absolute", top: "-10000px" });
    document.body.appendChild(miniDiv);
    const miniMap = L.map(miniDiv, { zoomControl: false, attributionControl: false });
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(miniMap);
    const miniLayer = L.geoJSON(resaltado.toGeoJSON(), { style: { color: "black", weight: 2, fillOpacity: 0 } }).addTo(miniMap);
    miniMap.fitBounds(miniLayer.getBounds(), { padding: [15, 15] });
    await new Promise(r => setTimeout(r, 600));
    const miniCanvas = await html2canvas(miniDiv, { useCORS: true, scale: 1.2, backgroundColor: "#ffffff" });
    pdf.addImage(miniCanvas.toDataURL("image/png"), "PNG", 125, 30, 70, 50);
    miniMap.remove();
    document.body.removeChild(miniDiv);

    // Informaci√≥n del predio
    const infoHTML = document.getElementById("info-content").innerText.split("\n").map(l => l.trim()).filter(l => l);
    const rows = infoHTML.map(line => { const [key, ...val] = line.split(":"); return [key, val.join(":").trim()]; });
    pdf.autoTable({ startY: 130, head: [["Campo", "Valor"]], body: rows, theme: "grid", styles: { fontSize: 10 } });

    const center = resaltado.getBounds().getCenter();
    pdf.setFont("helvetica", "italic");
    pdf.setFontSize(9);
    pdf.text(`Centro: ${center.lat.toFixed(5)}, ${center.lng.toFixed(5)} (EPSG:4326)`, 10, pdf.lastAutoTable.finalY + 10);
    pdf.text(`Generado: ${new Date().toLocaleString()}`, 10, pdf.lastAutoTable.finalY + 15);

    pdf.save(`Predio_${resaltado.feature?.properties?.PK_PREDIOS || "Briceno"}.pdf`);
  } catch (err) {
    alert("Error al generar el PDF: " + err.message);
  } finally {
    document.body.removeChild(loadingMsg);
  }
};
</script>
