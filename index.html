<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Info del Predio - Briceño en Mapas</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f5f5f5; color: #222; }
    #map { height: 70vh; width: 100%; border-bottom: 2px solid #999; }
    #info {
      padding: 15px 20px;
      background: white;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; color: #006400; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
    th, td { border: 1px solid #aaa; padding: 6px; text-align: left; }
    #footer { font-size: 11px; margin-top: 15px; color: #555; }
    #btnPDF { background: #00b050; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; margin-top: 15px; }
    #btnPDF:hover { background: #00873a; }
  </style>
</head>
<body>

  <h2>Información del Predio</h2>
  <div id="map"></div>

  <div id="info">
    <div id="atributos"></div>
    <button id="btnPDF">Descargar PDF</button>

    <div id="footer">
      <b>Autor:</b> Municipio de Briceño - Secretaría de Planeación<br>
      <b>Sistema de coordenadas:</b> WGS84 (EPSG:4326)<br>
      <b>Fecha:</b> <span id="fecha"></span>
    </div>
  </div>

  <script>
    const { jsPDF } = window.jspdf;
    document.getElementById("fecha").textContent = new Date().toLocaleString();

    // Crear mapa base
    const map = L.map("map").setView([7.132, -75.569], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    // Cargar todas las capas igual que el visor
    const baseUrl = "https://esteban-cms.github.io/BuscadorPredios/";
    const capas = {
      "Predios": "Predios_Usos_Agrupados.geojson",
      "Amenaza": "Condicion_Amenaza_Rura.geojson",
      "Riesgo": "CondicionRiesgoRural.geojson",
      "Protección": "Proteccion_GestionRiesgo.geojson",
      "Construcciones": "ConstruccionesRurales.geojson",
      "Drenaje": "Drenaje_Doble.geojson",
      "Veredas": "Veredas.geojson"
    };

    Object.entries(capas).forEach(([nombre, archivo]) => {
      fetch(baseUrl + archivo)
        .then(r => r.json())
        .then(data => {
          L.geoJSON(data, {
            style: { color: "#"+Math.floor(Math.random()*16777215).toString(16), weight: 1, fillOpacity: 0.2 }
          }).addTo(map);
        });
    });

    // Recuperar la info del predio desde el visor
    const infoPredio = localStorage.getItem("info_predio") || "No se seleccionó ningún predio.";
    const atributosDiv = document.getElementById("atributos");
    atributosDiv.innerHTML = `<pre>${infoPredio}</pre>`;

    // Generar PDF
    document.getElementById("btnPDF").addEventListener("click", async () => {
      const pdf = new jsPDF("landscape", "mm", "a4");
      const mapCanvas = await html2canvas(document.getElementById("map"), { useCORS: true, scale: 2 });
      const imgData = mapCanvas.toDataURL("image/png");

      pdf.addImage(imgData, "PNG", 10, 20, 270, 150);
      pdf.setFontSize(14);
      pdf.text("Municipio de Briceño - Secretaría de Planeación", 15, 15);
      pdf.setFontSize(10);
      pdf.text("Sistema de Coordenadas: WGS84 - EPSG:4326", 15, 182);
      pdf.text("Generado: " + new Date().toLocaleString(), 15, 188);

      const info = atributosDiv.innerText.split("\n");
      let y = 195;
      info.forEach(linea => { pdf.text(linea, 15, y); y += 5; });

      pdf.save("Info_del_Predio.pdf");
    });
  </script>
</body>
</html>
