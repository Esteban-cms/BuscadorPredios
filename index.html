/* ======================= DESCARGAR MAPA Y PREDIOS ======================= */

// Agregar botones al panel lateral sin alterar el dise침o original
const btnDescargarUno = document.createElement("button");
btnDescargarUno.innerHTML = "游닌 Descargar predio consultado";
btnDescargarUno.style = "width:100%;padding:8px;background:#03A9F4;border:none;border-radius:8px;cursor:pointer;margin-top:10px;";
document.getElementById("sidebar").appendChild(btnDescargarUno);

const btnDescargarVarios = document.createElement("button");
btnDescargarVarios.innerHTML = "游닍 Descargar varios predios";
btnDescargarVarios.style = "width:100%;padding:8px;background:#607D8B;border:none;border-radius:8px;cursor:pointer;margin-top:5px;";
document.getElementById("sidebar").appendChild(btnDescargarVarios);

// Cargar librer칤as necesarias
const html2canvasScript = document.createElement("script");
html2canvasScript.src = "https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js";
document.head.appendChild(html2canvasScript);

const jsPDFScript = document.createElement("script");
jsPDFScript.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";
document.head.appendChild(jsPDFScript);

// Esperar a que carguen las librer칤as antes de usar
jsPDFScript.onload = () => {

  async function capturarMapaConInfo(nombreArchivo = "Mapa_Predio.pdf") {
    // Crear canvas del mapa
    const mapDiv = document.getElementById("map");
    const infoDiv = document.getElementById("info-content");

    const canvas = await html2canvas(mapDiv, {
      useCORS: true,
      logging: false,
      backgroundColor: "#ffffff"
    });
    const imgData = canvas.toDataURL("image/png");

    // Crear PDF
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({
      orientation: "landscape",
      unit: "mm",
      format: "a4"
    });

    // T칤tulo y cr칠ditos
    pdf.setFontSize(14);
    pdf.text("Municipio de Brice침o - Antioquia", 15, 15);
    pdf.setFontSize(10);
    pdf.text("Mapa generado autom치ticamente desde Brice침o en Mapas", 15, 22);
    pdf.text("Sistema de coordenadas: WGS 84 (EPSG:4326)", 15, 27);
    pdf.text("Autor: Municipio de Brice침o", 15, 32);
    pdf.text(`Fecha: ${new Date().toLocaleDateString()}`, 15, 37);

    // Insertar imagen del mapa
    const imgWidth = 260;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    pdf.addImage(imgData, "PNG", 15, 45, imgWidth, imgHeight);

    // Dibujar norte simb칩lico
    pdf.setFontSize(20);
    pdf.text("N", 275, 55);
    pdf.line(275, 60, 275, 75);

    // Escala aproximada
    pdf.setFontSize(9);
    pdf.text("Escala gr치fica aproximada", 15, 190);
    pdf.line(15, 193, 75, 193);
    pdf.text("0", 15, 197);
    pdf.text("100 m", 70, 197);

    // Informaci칩n del predio (tabla simple)
    pdf.setFontSize(11);
    pdf.text("Informaci칩n del Predio", 15, 205);
    pdf.setFontSize(9);
    const infoTexto = infoDiv.innerText.split("\n").filter(t=>t.trim()!=="");
    let y = 210;
    infoTexto.forEach(t => {
      pdf.text(t, 15, y);
      y += 5;
    });

    pdf.save(nombreArchivo);
  }

  // Acci칩n: Descargar predio consultado
  btnDescargarUno.addEventListener("click", () => {
    const info = document.getElementById("info-content").innerText;
    if (!info || info.includes("Selecciona un predio")) {
      alert("Primero consulta un predio antes de descargar.");
      return;
    }
    capturarMapaConInfo("Predio_Consultado.pdf");
  });

  // Acci칩n: Descargar varios predios (historial b치sico)
  let historialConsultas = [];
  const oldMostrarPredio = mostrarPredio;
  mostrarPredio = function(f) {
    oldMostrarPredio(f);
    historialConsultas.push(f.properties.PK_PREDIOS);
  };

  btnDescargarVarios.addEventListener("click", () => {
    if (historialConsultas.length === 0) {
      alert("No hay historial de predios consultados.");
      return;
    }
    const blob = new Blob(
      [ "Historial de predios consultados:\n\n" + historialConsultas.join("\n") ],
      { type: "text/plain;charset=utf-8" }
    );
    const enlace = document.createElement("a");
    enlace.href = URL.createObjectURL(blob);
    enlace.download = "Historial_Predios.txt";
    enlace.click();
  });

};
