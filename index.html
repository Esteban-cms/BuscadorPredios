<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Brice침o en Mapas</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Turf.js -->
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

  <style>
    html, body {height:100%;margin:0;}
    #map {width:100%;height:100%;}
    #sidebar {
      position:absolute;
      top:10px;
      left:10px;
      width:300px;
      max-height:95%;
      background:white;
      border-radius:8px;
      padding:10px;
      overflow:auto;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      font-family:sans-serif;
      z-index:1000;
    }
    .info-table {
      border-collapse:collapse;
      width:100%;
      font-size:12px;
    }
    .info-table td {border:1px solid #ccc;padding:4px;}
    .checkbox-container {margin-top:10px;}
  </style>
</head>
<body>
  <div id="sidebar">
    <h3>Brice침o en Mapas</h3>
    <label for="searchBox">Buscar predio:</label>
    <input id="searchBox" type="text" placeholder="Ingrese PK_PREDIOS" style="width:100%;margin-bottom:10px;"/>
    <div id="info-content">Selecciona un predio para ver detalles.</div>
    <div class="checkbox-container" id="layer-controls"></div>
  </div>

  <div id="map"></div>

  <script>
  // ==================== MAPA BASE ====================
  const map = L.map('map').setView([7.109, -75.64], 13);
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'춸 OpenStreetMap'
  }).addTo(map);

  // ==================== CAPAS GEOJSON ====================
  let capaPredios, capaRiesgo, capaAmenaza, capaProteccion;

  // Controles de capas visibles
  const capasVisibles = {};

  function agregarControlCapa(nombre, capa, color){
    const cont = document.getElementById("layer-controls");
    const div = document.createElement("div");
    const check = document.createElement("input");
    check.type = "checkbox";
    check.checked = true;
    check.style.marginRight = "5px";
    const label = document.createElement("label");
    label.textContent = nombre;
    div.appendChild(check);
    div.appendChild(label);
    cont.appendChild(div);
    capasVisibles[nombre] = capa;
    check.addEventListener("change",()=>{
      if(check.checked) capa.addTo(map);
      else map.removeLayer(capa);
    });
  }

  // Cargar capas GeoJSON
  fetch("Predios_Rurales.geojson")
  .then(r=>r.json())
  .then(data=>{
    capaPredios = L.geoJSON(data,{
      style:{color:"green",weight:1,fillOpacity:0.2},
      onEachFeature:(f,l)=>{
        l.on("click",()=>mostrarPredio(f));
      }
    }).addTo(map);
    agregarControlCapa("Predios Rurales",capaPredios,"green");
  });

  fetch("Riesgo.geojson")
  .then(r=>r.json())
  .then(data=>{
    capaRiesgo = L.geoJSON(data,{style:{color:"orange",weight:1,fillOpacity:0.3}}).addTo(map);
    agregarControlCapa("Riesgo",capaRiesgo,"orange");
  });

  fetch("Amenaza.geojson")
  .then(r=>r.json())
  .then(data=>{
    capaAmenaza = L.geoJSON(data,{style:{color:"red",weight:1,fillOpacity:0.3}}).addTo(map);
    agregarControlCapa("Amenaza",capaAmenaza,"red");
  });

  fetch("Proteccion.geojson")
  .then(r=>r.json())
  .then(data=>{
    capaProteccion = L.geoJSON(data,{style:{color:"blue",weight:1,fillOpacity:0.3}}).addTo(map);
    agregarControlCapa("Protecci칩n",capaProteccion,"blue");
  });

  // ==================== BUSCADOR ====================
  document.getElementById("searchBox").addEventListener("change",()=>{
    const val = document.getElementById("searchBox").value.trim();
    capaPredios.eachLayer(l=>{
      if(l.feature.properties.PK_PREDIOS==val){
        mostrarPredio(l.feature);
        map.fitBounds(l.getBounds());
      }
    });
  });

  // ==================== FUNCI칍N DE MOSTRAR PREDIO ====================
  let f; let geom;
  function mostrarPredio(feature){
    f = feature;
    geom = feature.geometry;
    const props = feature.properties;
    let html = "<table class='info-table'>";
    for(let k in props){
      html += `<tr><td><b>${k}</b></td><td>${props[k]}</td></tr>`;
    }
    html += "</table>";
    document.getElementById("info-content").innerHTML = html;
  }

  // ==================== DESCARGA PDF DETALLADO ====================
  window.addEventListener("load", function() {
    const sidebar = document.getElementById("sidebar");
    const btnDescargarPDF = document.createElement("button");
    btnDescargarPDF.innerHTML = "游늯 Descargar mapa del predio";
    btnDescargarPDF.style = "width:100%;padding:8px;background:#4CAF50;color:white;border:none;border-radius:8px;cursor:pointer;margin-top:10px;";
    sidebar.appendChild(btnDescargarPDF);

    // Librer칤as
    const s1 = document.createElement("script");
    s1.src = "https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js";
    const s2 = document.createElement("script");
    s2.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";
    document.head.appendChild(s1);
    document.head.appendChild(s2);

    s2.onload = () => {
      const { jsPDF } = window.jspdf;

      async function generarPDFMapa() {
        const mapDiv = document.getElementById("map");
        const infoDiv = document.getElementById("info-content");

        if (!infoDiv || infoDiv.innerText.includes("Selecciona un predio")) {
          alert("Por favor selecciona un predio antes de descargar.");
          return;
        }

        // Captura mapa
        const canvas = await html2canvas(mapDiv,{useCORS:true,backgroundColor:"#ffffff"});
        const imgData = canvas.toDataURL("image/png");

        // Crear PDF
        const pdf = new jsPDF({orientation:"landscape",unit:"mm",format:"a4"});
        pdf.setFontSize(14);
        pdf.text("Municipio de Brice침o - Antioquia",15,15);
        pdf.setFontSize(10);
        pdf.text("Secretar칤a de Planeaci칩n",15,21);
        pdf.text("Sistema de Coordenadas: WGS84 (EPSG:4326)",15,27);
        pdf.text("Autor: Municipio de Brice침o - Secretar칤a de Planeaci칩n",15,33);
        pdf.text("Fecha de generaci칩n: "+new Date().toLocaleDateString(),15,39);

        // Imagen del mapa
        const imgWidth=260;
        const imgHeight=(canvas.height*imgWidth)/canvas.width;
        pdf.addImage(imgData,"PNG",15,45,imgWidth,imgHeight);

        // Norte
        pdf.setFontSize(18);
        pdf.text("N",275,55);
        pdf.line(275,60,275,80);

        // Escala
        pdf.setFontSize(9);
        pdf.text("Escala gr치fica aproximada",15,190);
        pdf.line(15,193,75,193);
        pdf.text("0",15,197);
        pdf.text("100 m",70,197);

        // Coordenadas
        pdf.setFontSize(8);
        pdf.text("Meridianos y paralelos (WGS84)",15,205);
        pdf.text("Latitud: "+map.getCenter().lat.toFixed(4)+"춿",15,210);
        pdf.text("Longitud: "+map.getCenter().lng.toFixed(4)+"춿",15,215);

        // Leyenda autom치tica
        pdf.setFontSize(10);
        pdf.text("Leyenda:",230,205);
        let yLey=210;
        for (let nombre in capasVisibles){
          if(map.hasLayer(capasVisibles[nombre])){
            const color = capasVisibles[nombre].options?.style?.color || "gray";
            pdf.setFillColor(color);
            pdf.rect(230,yLey,5,5,"F");
            pdf.text(nombre,238,yLey+4);
            yLey+=7;
          }
        }

        // Informaci칩n del predio
        pdf.setFontSize(11);
        pdf.text("Informaci칩n del Predio",15,225);
        pdf.setFontSize(9);
        let y=230;
        infoDiv.innerText.split("\n").forEach(line=>{
          if(line.trim()!==""){pdf.text(line,15,y);y+=5;}
        });

        pdf.save("Predio_Briceno.pdf");
      }

      btnDescargarPDF.addEventListener("click",generarPDFMapa);
    };
  });
  </script>
</body>
</html>
