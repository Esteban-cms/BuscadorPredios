<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<script>
  const map = L.map('map').setView([7.132, -75.569], 10);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 20,
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);

  let capaPredios, capaAmenaza, capaRiesgo, capaProteccion, resaltado;
  let listaMatriculas = [];

  fetch('Predios_Usos_Unidos_4326.geojson').then(r => r.json()).then(data => {
    capaPredios = L.geoJSON(data, {
      style: { color: '#00e676', weight: 1, fillOpacity: 0.3 },
      onEachFeature: (f, l) => {
        if (f.properties.PK_PREDIOS) listaMatriculas.push(f.properties.PK_PREDIOS);
        l.on('click', () => mostrarInfo(f));
      }
    }).addTo(map);
    map.fitBounds(capaPredios.getBounds());
  });

  fetch('Condicion_Amenaza_Rura.geojson').then(r => r.json()).then(data => {
    capaAmenaza = L.geoJSON(data, { style: { color: '#FF9800', weight: 1, fillOpacity: 0.2 }});
  });

  fetch('CondicionRiesgoRural.geojson').then(r => r.json()).then(data => {
    capaRiesgo = L.geoJSON(data, { style: { color: '#f44336', weight: 1, fillOpacity: 0.2 }});
  });

  fetch('Proteccion_GestionRiesgo.geojson').then(r => r.json()).then(data => {
    capaProteccion = L.geoJSON(data, { style: { color: '#2196F3', weight: 1, fillOpacity: 0.2 }});
  });

  // ğŸ“ Calcular Ã¡rea (referencial usando proyecciÃ³n mÃ©trica)
  function mostrarInfo(feature) {
    const info = document.getElementById('info-content');
    let areaHa = 'Sin calcular';

    try {
      const f4326 = feature;
      const f3857 = turf.toMercator(f4326, { mutate: false }); // reproyecciÃ³n a metros
      const areaM2 = turf.area(f3857);
      areaHa = (areaM2 / 10000).toFixed(2) + ' ha';
    } catch (e) {
      console.error('Error al calcular Ã¡rea:', e);
    }

    info.innerHTML = `
      <p><b>ğŸ“„ MatrÃ­cula:</b> ${feature.properties.PK_PREDIOS || 'Sin dato'}</p>
      <p><b>ğŸï¸ Vereda:</b> ${feature.properties.NOMBRE_VER || 'Sin dato'}</p>
      <p><b>ğŸšœ Uso:</b> ${feature.properties.Usos || 'Sin dato'}</p>
      <p><b>ğŸ“ Ãrea (referencial):</b> ${areaHa}</p>
      <p style="color:#ffeb3b; font-size:12px; margin-top:4px;">
        âš ï¸ Ãreas de referencia. Para conocer el Ã¡rea real del predio, dirÃ­jase a la autoridad competente o tramite un replanteo catastral.
      </p>
    `;

    if (resaltado) map.removeLayer(resaltado);
    resaltado = L.geoJSON(feature, {
      style: { color: 'yellow', weight: 3, fillOpacity: 0.1 }
    }).addTo(map);
    map.fitBounds(resaltado.getBounds());
  }

  const input = document.getElementById('search-input');
  const list = document.getElementById('autocomplete-list');

  input.addEventListener('input', function() {
    const val = this.value.toLowerCase();
    list.innerHTML = '';
    if (!val) return;
    const coincidencias = listaMatriculas.filter(m => m.toLowerCase().includes(val)).slice(0, 10);
    coincidencias.forEach(m => {
      const item = document.createElement('div');
      item.classList.add('autocomplete-item');
      item.textContent = m;
      item.onclick = () => {
        input.value = m;
        list.innerHTML = '';
        buscarPredio(m);
      };
      list.appendChild(item);
    });
  });

  function buscarPredio(texto) {
    if (!texto || !capaPredios) return alert('Escribe una matrÃ­cula vÃ¡lida.');
    let encontrado = false;
    capaPredios.eachLayer(layer => {
      if (layer.feature.properties.PK_PREDIOS == texto) {
        mostrarInfo(layer.feature);
        encontrado = true;
      }
    });
    if (!encontrado) alert('No se encontrÃ³ ese predio.');
  }

  document.getElementById('btnBuscar').onclick = () => buscarPredio(input.value.trim());

  document.getElementById('chkPredios').onchange = e => e.target.checked ? map.addLayer(capaPredios) : map.removeLayer(capaPredios);
  document.getElementById('chkAmenaza').onchange = e => e.target.checked ? map.addLayer(capaAmenaza) : map.removeLayer(capaAmenaza);
  document.getElementById('chkRiesgo').onchange = e => e.target.checked ? map.addLayer(capaRiesgo) : map.removeLayer(capaRiesgo);
  document.getElementById('chkProteccion').onchange = e => e.target.checked ? map.addLayer(capaProteccion) : map.removeLayer(capaProteccion);

  // ğŸ  Volver al inicio
  document.getElementById('btnHome').onclick = () => {
    map.setView([7.132, -75.569], 12);
  };

  // ğŸ“¡ Activar geolocalizaciÃ³n
  document.getElementById('btnLocate').onclick = () => {
    map.locate({ setView: true, maxZoom: 17 });
  };

  map.on('locationfound', e => {
    L.marker(e.latlng).addTo(map).bindPopup("ğŸ“ EstÃ¡s aquÃ­").openPopup();
  });

  // ğŸ¯ Ir a coordenadas
  document.getElementById('btnCoords').onclick = () => {
    const lat = prompt("Ingrese latitud:");
    const lon = prompt("Ingrese longitud:");
    if (lat && lon && !isNaN(lat) && !isNaN(lon)) {
      map.setView([parseFloat(lat), parseFloat(lon)], 16);
      L.marker([parseFloat(lat), parseFloat(lon)]).addTo(map).bindPopup(`Coordenadas:<br>${lat}, ${lon}`).openPopup();
    } else {
      alert("Coordenadas no vÃ¡lidas.");
    }
  };
</script>
