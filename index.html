<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Brice√±o en Mapas</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: 'Segoe UI', sans-serif; }
    #map { height: 100%; width: 100%; }

    /* Panel lateral */
    #sidebar {
      position: absolute;
      top: 0;
      left: 0;
      width: 310px;
      height: 100%;
      background: #111;
      color: white;
      padding: 15px;
      box-shadow: 3px 0 10px rgba(0,0,0,0.4);
      overflow-y: auto;
      z-index: 1000;
    }

    #sidebar h2 {
      text-align: center;
      font-size: 20px;
      margin-top: 10px;
      color: #00e676;
    }

    #sidebar img {
      display: block;
      margin: 10px auto;
      width: 90px;
      border-radius: 8px;
    }

    .layer-option {
      background: #222;
      border-radius: 8px;
      padding: 10px;
      margin: 8px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: background 0.3s;
    }

    .layer-option:hover { background: #333; }

    .layer-option span { font-size: 14px; }

    .layer-option input {
      width: 18px;
      height: 18px;
      accent-color: #00e676;
    }

    #search-container {
      background: #222;
      border-radius: 10px;
      padding: 10px;
      margin-top: 10px;
      position: relative;
    }

    #search-input {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: none;
      outline: none;
    }

    /* Estilos del autocompletador */
    #autocomplete-list {
      position: absolute;
      background: #333;
      border-radius: 6px;
      z-index: 9999;
      top: 40px;
      left: 0;
      right: 0;
      max-height: 180px;
      overflow-y: auto;
    }

    .autocomplete-item {
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #444;
    }

    .autocomplete-item:hover {
      background: #555;
    }

    #info-panel {
      background: #1b1b1b;
      margin-top: 15px;
      padding: 10px;
      border-radius: 10px;
      font-size: 13px;
      line-height: 1.5;
    }

    #map { margin-left: 310px; }

    .leaflet-popup-content { font-size: 13px; }
  </style>
</head>
<body>

  <!-- Panel lateral -->
  <div id="sidebar">
    <img src="escudo_briceno.jpg" alt="Escudo Brice√±o">
    <h2>Brice√±o en Mapas</h2>

    <div id="layers">
      <div class="layer-option">
        <span>üü© Predios Rurales</span>
        <input type="checkbox" id="chkPredios" checked>
      </div>
      <div class="layer-option">
        <span>üåã Condici√≥n de Amenaza Rural</span>
        <input type="checkbox" id="chkAmenaza">
      </div>
      <div class="layer-option">
        <span>‚ö†Ô∏è Condici√≥n de Riesgo Rural</span>
        <input type="checkbox" id="chkRiesgo">
      </div>
      <div class="layer-option">
        <span>üõ°Ô∏è Protecci√≥n y Gesti√≥n del Riesgo</span>
        <input type="checkbox" id="chkProteccion">
      </div>
    </div>

    <div id="search-container">
      <input type="text" id="search-input" placeholder="Buscar matr√≠cula (PK_PREDIOS)">
      <div id="autocomplete-list"></div>
      <button id="btnBuscar" style="margin-top:5px;width:100%;padding:8px;background:#00e676;border:none;border-radius:6px;cursor:pointer;">
        üîç Buscar
      </button>
    </div>

    <div id="info-panel">
      <b>‚ÑπÔ∏è Informaci√≥n del predio</b>
      <div id="info-content">Selecciona un predio o b√∫scalo por matr√≠cula.</div>
    </div>
  </div>

  <div id="map"></div>

  <script>
    const map = L.map('map').setView([7.132, -75.569], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20,
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    let capaPredios, capaAmenaza, capaRiesgo, capaProteccion, resaltado;
    let listaMatriculas = [];

    // Funci√≥n para calcular el √°rea en hect√°reas
    function calcularArea(feature) {
      try {
        const area_m2 = turf.area(feature);
        return (area_m2 / 10000).toFixed(2) + ' ha';
      } catch {
        return 'Sin c√°lculo';
      }
    }

    // Cargar librer√≠a Turf.js para c√°lculo de √°rea
    const scriptTurf = document.createElement('script');
    scriptTurf.src = 'https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js';
    document.head.appendChild(scriptTurf);

    // Cargar capa de predios
    fetch('Predios_Usos_Unidos_4326.geojson').then(r => r.json()).then(data => {
      capaPredios = L.geoJSON(data, {
        style: { color: '#00e676', weight: 1, fillOpacity: 0.3 },
        onEachFeature: (f, l) => {
          if (f.properties.PK_PREDIOS) listaMatriculas.push(f.properties.PK_PREDIOS);
          f.properties.area_ha = calcularArea(f);
          l.on('click', () => mostrarInfo(f));
        }
      }).addTo(map);
      map.fitBounds(capaPredios.getBounds());
    });

    // Cargar otras capas
    fetch('Condicion_Amenaza_Rura.geojson').then(r => r.json()).then(data => {
      capaAmenaza = L.geoJSON(data, { style: { color: '#FF9800', weight: 1, fillOpacity: 0.2 }}); 
    });
    fetch('Condicion_Riesgo_Rural.geojson').then(r => r.json()).then(data => {
      capaRiesgo = L.geoJSON(data, { style: { color: '#f44336', weight: 1, fillOpacity: 0.2 }}); 
    });
    fetch('Proteccion_GestionRiesgo.geojson').then(r => r.json()).then(data => {
      capaProteccion = L.geoJSON(data, { style: { color: '#2196F3', weight: 1, fillOpacity: 0.2 }}); 
    });

    // Mostrar informaci√≥n del predio
    function mostrarInfo(feature) {
      const info = document.getElementById('info-content');
      info.innerHTML = `
        <p><b>üìÑ Matr√≠cula:</b> ${feature.properties.PK_PREDIOS || 'Sin dato'}</p>
        <p><b>üèûÔ∏è Vereda:</b> ${feature.properties.NOMBRE_VER || 'Sin dato'}</p>
        <p><b>üöú Uso:</b> ${feature.properties.Usos || 'Sin dato'}</p>
        <p><b>üìê √Årea:</b> ${feature.properties.area_ha || 'Sin c√°lculo'}</p>
      `;
      if (resaltado) map.removeLayer(resaltado);
      resaltado = L.geoJSON(feature, {
        style: { color: 'yellow', weight: 3, fillOpacity: 0.1 }
      }).addTo(map);
      map.fitBounds(resaltado.getBounds());
    }

    // Autocompletador
    const input = document.getElementById('search-input');
    const list = document.getElementById('autocomplete-list');

    input.addEventListener('input', function() {
      const val = this.value.toLowerCase();
      list.innerHTML = '';
      if (!val) return;
      const coincidencias = listaMatriculas.filter(m => m.toLowerCase().includes(val)).slice(0, 10);
      coincidencias.forEach(m => {
        const item = document.createElement('div');
        item.classList.add('autocomplete-item');
        item.textContent = m;
        item.onclick = () => {
          input.value = m;
          list.innerHTML = '';
          buscarPredio(m);
        };
        list.appendChild(item);
      });
    });

    // Buscar predio por matr√≠cula
    function buscarPredio(texto) {
      if (!texto || !capaPredios) return alert('Escribe una matr√≠cula v√°lida.');
      let encontrado = false;
      capaPredios.eachLayer(layer => {
        if (layer.feature.properties.PK_PREDIOS == texto) {
          mostrarInfo(layer.feature);
          encontrado = true;
        }
      });
      if (!encontrado) alert('No se encontr√≥ ese predio.');
    }

    document.getElementById('btnBuscar').onclick = () => buscarPredio(input.value.trim());

    // Checkboxes para mostrar/ocultar capas
    document.getElementById('chkPredios').onchange = e => e.target.checked ? map.addLayer(capaPredios) : map.removeLayer(capaPredios);
    document.getElementById('chkAmenaza').onchange = e => e.target.checked ? map.addLayer(capaAmenaza) : map.removeLayer(capaAmenaza);
    document.getElementById('chkRiesgo').onchange = e => e.target.checked ? map.addLayer(capaRiesgo) : map.removeLayer(capaRiesgo);
    document.getElementById('chkProteccion').onchange = e => e.target.checked ? map.addLayer(capaProteccion) : map.removeLayer(capaProteccion);
  </script>
</body>
</html>
